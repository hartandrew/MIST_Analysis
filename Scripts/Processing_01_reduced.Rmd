---
title: "Processing_01"
author: "AndrewHart"
date: "`r Sys.Date()`"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

## R Markdown

This is an R Markdown document. Markdown is a simple formatting syntax for authoring HTML, PDF, and MS Word documents. For more details on using R Markdown see <http://rmarkdown.rstudio.com>.

When you click the **Knit** button a document will be generated that includes both content as well as the output of any embedded R code chunks within the document. You can embed an R code chunk like this:

```{r cars}
summary(cars)
```

## Including Plots

You can also embed plots, for example:

```{r pressure, echo=FALSE}
plot(pressure)
```

##Load the Libraries----
```{r, warning=FALSE, error=FALSE}
library(Seurat)
library(Signac)
library(dplyr)
library(ggplot2)
library(reshape2)
library(data.table)
library(cowplot)
library(scCustomize)
library(forcats)
library(ggbreak)
library(presto)
library(ggforce)
library(glmGamPoi)
library(future)
library(dsb)
library(RColorBrewer)
library(monocle3)
library(gt)
library(SeuratDisk)
options(future.globals.maxSize = 5000 * 1024^2)
```

#directory set up
```{r}
getwd() #/home/hartandrew
setwd("/data/hartandrew/MIST/SingleCell")
out <- "/data/hartandrew/MIST/SingleCell/Output"
images <- "/data/hartandrew/MIST/SingleCell/Output/Images"
seurat_objs <- "/data/hartandrew/MIST/SingleCell/Output/Seurat_files"
```


#Create file lists
```{r}
raw_files_list <- list("/data/hartandrew/CellRanger/CHMI_183/MIST2482_MLN/outs/raw_feature_bc_matrix/", 
                       "/data/hartandrew/CellRanger/CHMI_183/MIST2482_LP/outs/raw_feature_bc_matrix/", 
                       "/data/hartandrew/CellRanger/CHMI_183/MIST2482_IEL/outs/raw_feature_bc_matrix/", 
                       "/data/hartandrew/CellRanger/CHMI_183/MIST2489_MLN/outs/raw_feature_bc_matrix/", 
                       "/data/hartandrew/CellRanger/CHMI_183/MIST2489_LP/outs/raw_feature_bc_matrix/", 
                       "/data/hartandrew/CellRanger/CHMI_183/MIST2489_IEL/outs/raw_feature_bc_matrix/", 
                       "/data/hartandrew/CellRanger/CHMI_190/MIST24109_MLN/outs/raw_feature_bc_matrix/", 
                       "/data/hartandrew/CellRanger/CHMI_190/MIST24109_LP/outs/raw_feature_bc_matrix/", 
                       "/data/hartandrew/CellRanger/CHMI_190/MIST24109_IEL/outs/raw_feature_bc_matrix/", 
                       "/data/hartandrew/CellRanger/CHMI_190/MIST2493_MLN/outs/raw_feature_bc_matrix/", 
                       "/data/hartandrew/CellRanger/CHMI_190/MIST2493_LP/outs/raw_feature_bc_matrix/", 
                       "/data/hartandrew/CellRanger/CHMI_192/MIST24134_LP/outs/raw_feature_bc_matrix/", 
                       "/data/hartandrew/CellRanger/CHMI_192/MIST24134_MLN/outs/raw_feature_bc_matrix/", 
                       "/data/hartandrew/CellRanger/CHMI_192/MIST24134_IEL/outs/raw_feature_bc_matrix/", 
                       "/data/hartandrew/CellRanger/CHMI_197/MIST24142_MLN/outs/raw_feature_bc_matrix/", 
                       "/data/hartandrew/CellRanger/CHMI_197/MIST24142_IEL/outs/raw_feature_bc_matrix/", 
                       "/data/hartandrew/CellRanger/CHMI_197/MIST24142_LP/outs/raw_feature_bc_matrix/", 
                       "/data/hartandrew/CellRanger/CHMI_204/MIST24180_MLN/outs/raw_feature_bc_matrix/")
filtered_files_list <- list( "/data/hartandrew/CellRanger/CHMI_183/MIST2482_MLN/outs/filtered_feature_bc_matrix/", 
                             "/data/hartandrew/CellRanger/CHMI_183/MIST2482_LP/outs/filtered_feature_bc_matrix/",
                              "/data/hartandrew/CellRanger/CHMI_183/MIST2482_IEL/outs/filtered_feature_bc_matrix/", 
                             "/data/hartandrew/CellRanger/CHMI_183/MIST2489_MLN/outs/filtered_feature_bc_matrix/", 
                             "/data/hartandrew/CellRanger/CHMI_183/MIST2489_LP/outs/filtered_feature_bc_matrix/", 
                             "/data/hartandrew/CellRanger/CHMI_183/MIST2489_IEL/outs/filtered_feature_bc_matrix/", 
                             "/data/hartandrew/CellRanger/CHMI_190/MIST24109_MLN/outs/filtered_feature_bc_matrix/", 
                             "/data/hartandrew/CellRanger/CHMI_190/MIST24109_LP/outs/filtered_feature_bc_matrix/", 
                             "/data/hartandrew/CellRanger/CHMI_190/MIST24109_IEL/outs/filtered_feature_bc_matrix/", 
                             "/data/hartandrew/CellRanger/CHMI_190/MIST2493_MLN/outs/filtered_feature_bc_matrix/", 
                             "/data/hartandrew/CellRanger/CHMI_190/MIST2493_LP/outs/filtered_feature_bc_matrix/", 
                             "/data/hartandrew/CellRanger/CHMI_192/MIST24134_LP/outs/filtered_feature_bc_matrix/", 
                             "/data/hartandrew/CellRanger/CHMI_192/MIST24134_MLN/outs/filtered_feature_bc_matrix/", 
                             "/data/hartandrew/CellRanger/CHMI_192/MIST24134_IEL/outs/filtered_feature_bc_matrix/", 
                             "/data/hartandrew/CellRanger/CHMI_197/MIST24142_MLN/outs/filtered_feature_bc_matrix/", 
                             "/data/hartandrew/CellRanger/CHMI_197/MIST24142_IEL/outs/filtered_feature_bc_matrix/", 
                             "/data/hartandrew/CellRanger/CHMI_197/MIST24142_LP/outs/filtered_feature_bc_matrix/", 
                             "/data/hartandrew/CellRanger/CHMI_204/MIST24180_MLN/outs/filtered_feature_bc_matrix/")
samples_list <- list("CHMI2482_MLN",  "CHMI2482_LP", "CHMI2482_IEL", 
                    "CHMI2489_MLN", "CHMI2489_LP", "CHMI2489_IEL", 
                    "CHMI24109_MLN", "CHMI24109_LP", "CHMI24109_IEL", 
                    "CHMI2493_MLN", "CHMI2493_LP", 
                    "CHMI24134_LP", "CHMI24134_MLN", "CHMI24134_IEL", 
                    "CHMI24142_MLN", "CHMI24142_IEL", "CHMI24142_LP", 
                    "CHMI24180_MLN")  
meta <-list()
qc_cells <-list()
seurat_list <- list()
```

## Load Samples, Filter Cells, Normalize ADT data for each sample
```{r}
for (i in 1:length(raw_files_list)){
  
  raw.data <- Read10X(data.dir = raw_files_list[[i]])
  filtered.data <- Read10X(data.dir = filtered_files_list[[i]])
  # define cell-containing barcodes and separate cells and empty drops
  stained_cells = colnames(filtered.data$`Gene Expression`)
  prot = raw.data$`Antibody Capture`
  rna = raw.data$`Gene Expression` 
  
#Add proportion mitochondrial
  mtgene = grep(pattern = "^mt-", rownames(rna), value = TRUE) # used below

  meta[[i]] <- data.frame(
  rna.size = log10(Matrix::colSums(rna)), 
  prot.size = log10(Matrix::colSums(prot)), 
  n.gene = Matrix::colSums(rna > 0), 
  mt.prop = Matrix::colSums(rna[mtgene, ]) / Matrix::colSums(rna))

# add indicator for barcodes Cell Ranger called as cells
  meta[[i]]$drop.class<-  ifelse(rownames(meta[[i]]) %in% stained_cells, 'cell', 'background')
# remove barcodes with no evidence of capture in the experiment
  meta[[i]] = meta[[i]][meta[[i]]$rna.size > 0 & meta[[i]]$prot.size > 0, ]
  cellmd = meta[[i]][meta[[i]]$drop.class == 'cell', ]

#Visualize baseline
  ggplot(meta[[i]], aes(x = log10(n.gene), y = prot.size )) +
   theme_bw() + 
   geom_bin2d(bins = 300) + 
   scale_fill_viridis_c(option = "C") + 
   facet_wrap(~drop.class)
  ggplot(meta[[i]], aes(x = log10(n.gene), y = rna.size )) +
   theme_bw() + 
   geom_bin2d(bins = 300) + 
   scale_fill_viridis_c(option = "C") + 
   facet_wrap(~drop.class)

# Identify background
  background_drops = rownames(meta[[i]][ 
      meta[[i]]$prot.size < 3 & 
      meta[[i]]$rna.size < 2.5, ]) 
  
  background.adt.mtx = as.matrix(prot[ , background_drops])

# filter drops with + / - 2.5 median absolute deviations from the median library size
  rna.mult = (2.5*mad(cellmd$rna.size))
  prot.mult = (2.5*mad(cellmd$prot.size))
  rna.lower = median(cellmd$rna.size) - rna.mult
  rna.upper = median(cellmd$rna.size) + rna.mult
  prot.lower = median(cellmd$prot.size) - prot.mult
  prot.upper = median(cellmd$prot.size) + prot.mult

# filter rows based on droplet qualty control metrics
  qc_cells[[i]] = rownames(
  cellmd[cellmd$prot.size > prot.lower & 
         cellmd$prot.size < prot.upper & 
         cellmd$rna.size > rna.lower & 
         cellmd$rna.size < rna.upper & 
         cellmd$mt.prop < 0.20, ])

  length(qc_cells[[i]])

  cell.adt.raw = as.matrix(prot[ ,qc_cells[[i]]])
  cell.rna.raw = rna[ ,qc_cells[[i]]]
  cellmd_filt = cellmd[qc_cells[[i]], ]

#Perform Protein Normalization with dsb
  pm = sort(apply(cell.adt.raw, 1, max))
  pm2 = apply(background.adt.mtx, 1, max)
  head(pm, n=40)
  rownames(cell.adt.raw)
  isotype.controls = c("Isotype_RTK4530", "Isotype_HTK888", 
                     "Isotype_RTK2071", "Isotype_RTK2758", "Isotype_MOPC.173", "Isotype_MOPC.21", "Isotype_MPC.11")

  cells.dsb.norm = DSBNormalizeProtein(
  cell_protein_matrix = cell.adt.raw, 
  empty_drop_matrix = background.adt.mtx, 
  denoise.counts = TRUE, 
  use.isotype.control = TRUE, 
  isotype.control.name.vec = isotype.controls)

  stopifnot(isTRUE(all.equal(rownames(cellmd_filt), colnames(cell.adt.raw))))
  stopifnot(isTRUE(all.equal(rownames(cellmd_filt), colnames(cell.rna.raw))))

# create Seurat object note: min.cells is a gene filter, not a cell filter
  seurat_list[[i]] <- Seurat::CreateSeuratObject(counts = cell.rna.raw, 
                               meta.data = cellmd_filt,
                               assay = "RNA", 
                               min.cells = 20)

# add dsb normalized matrix "cell.adt.dsb" to the "CITE" data (not counts!) slot
  seurat_list[[i]][["ADT"]] = Seurat::CreateAssayObject(data = cells.dsb.norm)
  seurat_list[[i]]
  rownames(seurat_list[[i]][["ADT"]])
  FeatureScatter(seurat_list[[i]], feature1 = "CD19", feature2 = "CD8a")
  FeatureScatter(seurat_list[[i]], feature1 = "CD45R-B220", feature2 = "CD19", pt.size = 0.5)


  feats <- c("nFeature_RNA","nCount_RNA","mt.prop")
  VlnPlot(seurat_list[[i]], group.by= "orig.ident", features = feats, pt.size = 0.1, combine = T, ncol = 3,cols = "#FB20FE" ) +
  ggtitle(noquote(paste0(samples_list[[i]]))) + NoLegend()

  ggsave(paste0(samples_list[[i]],"_RNA_QC_violins.png"), plot = last_plot(),  device = NULL,
  path = images,  scale = 1, width = 7,  height = 5,
  units = c("in"), dpi = 600, limitsize = TRUE,  bg = NULL)
}
```

#Quickly visualize Protein data QC

```{r}
for (i in 1:length(seurat_list))
  FeatureScatter(seurat_list[[i]], feature1 = "CD19", feature2 = "CD8a")
  FeatureScatter(seurat_list[[i]], feature1 = "CD45R-B220", feature2 = "CD19", pt.size = 0.5)
  }
```

# Add Metadata to the samples
 I noticed the the original ID of the samples is not the sample name and is just "SeuratProject" - we will fix this and add pertinent info about the infection status, batch, and tissue type
```{r}
samples_list <- list("CHMI2482_MLN",  "CHMI2482_LP", "CHMI2482_IEL", 
                    "CHMI2489_MLN", "CHMI2489_LP", "CHMI2489_IEL", 
                    "CHMI24109_MLN", "CHMI24109_LP", "CHMI24109_IEL", 
                    "CHMI2493_MLN", "CHMI2493_LP", 
                    "CHMI24134_LP", "CHMI24134_MLN", "CHMI24134_IEL", 
                    "CHMI24142_MLN", "CHMI24142_IEL", "CHMI24142_LP", 
                    "CHMI24180_MLN")  



CHMI2482_MLN <- seurat_list[[1]]
CHMI2482_MLN@meta.data["orig.ident"] <- "CHMI2482_MLN"
CHMI2482_MLN@meta.data["Mouse"] <- "CHMI2482"
CHMI2482_MLN@meta.data["Tissue"] <- "Mesenteric Lymph Node"
CHMI2482_MLN@meta.data["InfectionStatus"] <- "Naive"
CHMI2482_MLN_Meta = CHMI2482_MLN@meta.data
head(CHMI2482_MLN_Meta)

CHMI2482_LP <- seurat_list[[2]]
CHMI2482_LP@meta.data["orig.ident"] <- "CHMI2482_LP"
CHMI2482_LP@meta.data["Mouse"] <- "CHMI2482"
CHMI2482_LP@meta.data["Tissue"] <- "Lamina Propria"
CHMI2482_LP@meta.data["InfectionStatus"] <- "Naive"

CHMI2482_IEL <- seurat_list[[3]]
CHMI2482_IEL@meta.data["orig.ident"] <- "CHMI2482_IEL"
CHMI2482_IEL@meta.data["Mouse"] <- "CHMI2482"
CHMI2482_IEL@meta.data["Tissue"] <- "Intra-Epithelial Lymphocytes"
CHMI2482_IEL@meta.data["InfectionStatus"] <- "Naive"

CHMI2489_MLN <- seurat_list[[4]]
CHMI2489_MLN@meta.data["orig.ident"] <- "CHMI2489_MLN"
CHMI2489_MLN@meta.data["Mouse"] <- "CHMI2489"
CHMI2489_MLN@meta.data["Tissue"] <- "Mesenteric Lymph Node"
CHMI2489_MLN@meta.data["InfectionStatus"] <- "Cryptosporidium"

CHMI2489_LP <- seurat_list[[5]]
CHMI2489_LP@meta.data["orig.ident"] <- "CHMI2489_LP"
CHMI2489_LP@meta.data["Mouse"] <- "CHMI2489"
CHMI2489_LP@meta.data["Tissue"] <- "Lamina Propria"
CHMI2489_LP@meta.data["InfectionStatus"] <- "Cryptosporidium"

CHMI2489_IEL <- seurat_list[[6]]
CHMI2489_IEL@meta.data["orig.ident"] <- "CHMI2489_IEL"
CHMI2489_IEL@meta.data["Mouse"] <- "CHMI2489"
CHMI2489_IEL@meta.data["Tissue"] <- "Intra-Epithelial Lymphocytes"
CHMI2489_IEL@meta.data["InfectionStatus"] <- "Cryptosporidium"

CHMI24109_MLN <- seurat_list[[7]]
CHMI24109_MLN@meta.data["orig.ident"] <- "CHMI24109_MLN"
CHMI24109_MLN@meta.data["Mouse"] <- "CHMI24109"
CHMI24109_MLN@meta.data["Tissue"] <- "Mesenteric Lymph Node"
CHMI24109_MLN@meta.data["InfectionStatus"] <- "Naive"

CHMI24109_LP <- seurat_list[[8]]
CHMI24109_LP@meta.data["orig.ident"] <- "CHMI24109_LP"
CHMI24109_LP@meta.data["Mouse"] <- "CHMI24109"
CHMI24109_LP@meta.data["Tissue"] <- "Lamina Propria"
CHMI24109_LP@meta.data["InfectionStatus"] <- "Naive"

CHMI24109_IEL <- seurat_list[[9]]
CHMI24109_IEL@meta.data["orig.ident"] <- "CHMI24109_IEL"
CHMI24109_IEL@meta.data["Mouse"] <- "CHMI24109"
CHMI24109_IEL@meta.data["Tissue"] <- "Intra-Epithelial Lymphocytes"
CHMI24109_IEL@meta.data["InfectionStatus"] <- "Naive"

CHMI2493_MLN <- seurat_list[[10]]
CHMI2493_MLN@meta.data["orig.ident"] <- "CHMI2493_MLN"
CHMI2493_MLN@meta.data["Mouse"] <- "CHMI2493"
CHMI2493_MLN@meta.data["Tissue"] <- "Mesenteric Lymph Node"
CHMI2493_MLN@meta.data["InfectionStatus"] <- "Cryptosporidium"

CHMI2493_LP <- seurat_list[[11]]
CHMI2493_LP@meta.data["orig.ident"] <- "CHMI2493_LP"
CHMI2493_LP@meta.data["Mouse"] <- "CHMI2493"
CHMI2493_LP@meta.data["Tissue"] <- "Lamina Propria"
CHMI2493_LP@meta.data["InfectionStatus"] <- "Cryptosporidium"

CHMI24134_LP <- seurat_list[[12]]
CHMI24134_LP@meta.data["orig.ident"] <- "CHMI24134_LP"
CHMI24134_LP@meta.data["Mouse"] <- "CHMI24134"
CHMI24134_LP@meta.data["Tissue"] <- "Lamina Propria"
CHMI24134_LP@meta.data["InfectionStatus"] <- "Yersinia"

CHMI24134_MLN <- seurat_list[[13]]
CHMI24134_MLN@meta.data["orig.ident"] <- "CHMI24134_MLN"
CHMI24134_MLN@meta.data["Mouse"] <- "CHMI24134"
CHMI24134_MLN@meta.data["Tissue"] <- "Mesenteric Lymph Node"
CHMI24134_MLN@meta.data["InfectionStatus"] <- "Yersinia"

CHMI24134_IEL <- seurat_list[[14]]
CHMI24134_IEL@meta.data["orig.ident"] <- "CHMI24134_IEL"
CHMI24134_IEL@meta.data["Mouse"] <- "CHMI24134"
CHMI24134_IEL@meta.data["Tissue"] <- "Intra-Epithelial Lymphocytes"
CHMI24134_IEL@meta.data["InfectionStatus"] <- "Yersinia"

CHMI24142_MLN <- seurat_list[[15]]
CHMI24142_MLN@meta.data["orig.ident"] <- "CHMI24142_MLN"
CHMI24142_MLN@meta.data["Mouse"] <- "CHMI24142"
CHMI24142_MLN@meta.data["Tissue"] <- "Mesenteric Lymph Node"
CHMI24142_MLN@meta.data["InfectionStatus"] <- "Yersinia"

CHMI24142_IEL <- seurat_list[[16]]
CHMI24142_IEL@meta.data["orig.ident"] <- "CHMI24142_IEL"
CHMI24142_IEL@meta.data["Mouse"] <- "CHMI24142"
CHMI24142_IEL@meta.data["Tissue"] <- "Intra-Epithelial Lymphocytes"
CHMI24142_IEL@meta.data["InfectionStatus"] <- "Yersinia"

CHMI24142_LP <- seurat_list[[17]]
CHMI24142_LP@meta.data["orig.ident"] <- "CHMI24142_LP"
CHMI24142_LP@meta.data["Mouse"] <- "CHMI24142"
CHMI24142_LP@meta.data["Tissue"] <- "Lamina Propria"
CHMI24142_LP@meta.data["InfectionStatus"] <- "Yersinia"

CHMI24180_MLN <- seurat_list[[18]]
CHMI24180_MLN@meta.data["orig.ident"] <- "CHMI24180_MLN"
CHMI24180_MLN@meta.data["Mouse"] <- "CHMI24180"
CHMI24180_MLN@meta.data["Tissue"] <- "Lamina Propria"
CHMI24180_MLN@meta.data["InfectionStatus"] <- "H_Poly"



```

#The Individual files are loaded and metadata added in the saved R environment "MIST_Individual_sample_obj.RData"

#MergeData
```{r}
#Merge the data sets - based on combined
combined_Data <- merge(CHMI2482_MLN, y = c( CHMI2482_LP, CHMI2482_IEL, CHMI2489_MLN, CHMI2489_IEL, CHMI2489_LP, CHMI24109_IEL, CHMI24109_LP, CHMI24109_MLN, CHMI2493_MLN, CHMI2493_LP, CHMI24134_MLN, CHMI24134_LP, CHMI24134_IEL, CHMI24142_MLN, CHMI24142_IEL, CHMI24142_LP, CHMI24180_MLN), add.cell.ids = c("CHMI2482_MLN", "CHMI2482_LP", "CHMI2482_IEL", "CHMI2489_MLN", "CHMI2489_IEL", "CHMI2489_LP", "CHMI24109_IEL", "CHMI24109_LP", "CHMI24109_MLN", "CHMI2493_MLN", "CHMI2493_LP", "CHMI24134_MLN", "CHMI24134_LP", "CHMI24134_IEL", "CHMI24142_MLN", "CHMI24142_IEL", "CHMI24142_LP", "CHMI24180_MLN"), project = "Combined", merge.data = TRUE)

Layers(combined_Data[['ADT']]) 
Layers(combined_Data[['RNA']]) # The layer names are not informative so we will rejoin and split by the informative characteristics
```

#QC Averages across samples
```{r}
rna_counts <-c() # define empty obj
rna_counts_sd <- c()
Idents(combined_Data) <- "orig.ident"
for (ident in  levels(combined_Data@active.ident)) {
  rna_counts <- c(rna_counts, mean(combined_Data@meta.data$nCount_RNA[combined_Data@meta.data$orig.ident==ident]))}
for (ident in  levels(combined_Data@active.ident)) {
  rna_counts_sd <- c(rna_counts_sd, sd(combined_Data@meta.data$nCount_RNA[combined_Data@meta.data$orig.ident==ident]))}
rna_counts <- as.data.frame(rna_counts)
rna_counts$sample <- levels(combined_Data@active.ident)
colnames(rna_counts) <- c("mean_RNAcount", "Sample")
rna_counts$SD <- rna_counts_sd
rna_counts$infection <- rna_counts$Sample
rna_counts$infection[rna_counts$Sample %like% "CHMI2482" | rna_counts$Sample %like% "CHMI24109"] <- "Naive"
rna_counts$infection[rna_counts$Sample %like% "CHMI2489" | rna_counts$Sample %like% "CHMI2493"] <- "Cryptosporidium"
rna_counts$infection[rna_counts$Sample %like% "CHMI24134"| rna_counts$Sample %like% "CHMI24142"] <- "Yersinia"
rna_counts$infection[rna_counts$Sample %like% "CHMI24180"] <- "H_poly"
 rna_counts %>%
   mutate(Sample = fct_reorder(Sample,  dplyr::desc(mean_RNAcount)))  %>%
ggplot( aes(Sample, mean_RNAcount)) + 
  geom_col(aes(fill = infection)) + 
   scale_fill_manual(values=c("#0500a1", "#f2b713", "#d95327", "#f000ee")) + 
    theme(panel.background = element_rect(fill = "white", 
            colour = NA), panel.border = element_rect(fill = NA, 
            colour = "grey20"), panel.grid = element_line(colour = "grey92"), 
            panel.grid.minor = element_line(linewidth = rel(0.5)), 
            strip.background = element_rect(fill = "grey85", 
                colour = "grey20"), axis.text.x = element_text(angle = 90, vjust = 0.5, hjust=1)) 

  ggsave("QC_Mean_RNA_count_barchart.png",plot = last_plot(), device = NULL,
  path = images,scale = 1, width = 7, height = 5,  units = c("in"),
  dpi = 600, limitsize = TRUE, bg = NULL)
```




#Save QC plots across samples
```{r}
v4 <- c("CHMI24109_IEL", "CHMI24109_LP", "CHMI24109_MLN", "CHMI2493_MLN", "CHMI2493_LP", "CHMI24134_MLN", "CHMI24134_LP", "CHMI24134_IEL", "CHMI24142_MLN", "CHMI24142_IEL", "CHMI24142_LP", "CHMI24180_MLN")
v3 <- c("CHMI2482_MLN", "CHMI2482_LP", "CHMI2482_IEL", "CHMI2489_MLN", "CHMI2489_IEL", "CHMI2489_LP")
combined_Data@meta.data$Chemistry[combined_Data$orig.ident %in% v4] <- "10X_v4"
combined_Data@meta.data$Chemistry[combined_Data$orig.ident %in% v3] <- "10X_v3"

 VlnPlot(combined_Data, features = c("nFeature_RNA"), pt.size = 0, group.by = "orig.ident", split.by = "Chemistry") + NoLegend() +  theme(panel.background = element_rect(fill = "white", 
            colour = NA), panel.border = element_rect(fill = NA, 
            colour = "grey20"), panel.grid = element_line(colour = "grey92"), 
            panel.grid.minor = element_line(linewidth = rel(0.5)), 
            strip.background = element_rect(fill = "grey85", 
            colour = "grey20"), axis.title.x = element_blank(),  axis.text.x = element_text(angle = 90, vjust = 0.5, hjust=1)) 
   ggsave("Violin_RNA_feature_per_sample.png",plot = last_plot(), device = NULL,
  path = images, scale = 1, width = 8, height = 5,  units = c("in"),
  dpi = 600, limitsize = TRUE, bg = NULL)
   
  VlnPlot(combined_Data, features = c("nCount_RNA"), pt.size = 0, group.by = "orig.ident", split.by = "Chemistry") + NoLegend() +  theme(panel.background = element_rect(fill = "white", 
            colour = NA), panel.border = element_rect(fill = NA, 
            colour = "grey20"), panel.grid = element_line(colour = "grey92"), 
            panel.grid.minor = element_line(linewidth = rel(0.5)), 
            strip.background = element_rect(fill = "grey85", 
            colour = "grey20"), axis.title.x = element_blank(),  axis.text.x = element_text(angle = 90, vjust = 0.5, hjust=1)) 
     ggsave("Violin_RNA_count_per_sample.png",plot = last_plot(), device = NULL,
  path = images,scale = 1, width = 8, height = 5,  units = c("in"),
  dpi = 600, limitsize = TRUE, bg = NULL)
     
    VlnPlot(combined_Data, features = c("mt.prop"), pt.size = 0, group.by = "orig.ident", split.by = "Chemistry") + NoLegend() +  theme(panel.background = element_rect(fill = "white", 
            colour = NA), panel.border = element_rect(fill = NA, 
            colour = "grey20"), panel.grid = element_line(colour = "grey92"), 
            panel.grid.minor = element_line(linewidth = rel(0.5)), 
            strip.background = element_rect(fill = "grey85", 
            colour = "grey20"), axis.title.x = element_blank(),  axis.text.x = element_text(angle = 90, vjust = 0.5, hjust=1)) 
    FeatureScatter(combined_Data, feature1 = "nCount_RNA", feature2 = "nFeature_RNA") + facet_wrap(~combined_Data@meta.data$orig.ident)


```
#Save the combined file
```{r}
combined_Data[["RNA"]] <- as(object = combined_Data[["RNA"]], Class = "Assay")
SaveH5Seurat(combined_Data, filename = "/data/hartandrew/MIST/SingleCell/Output/Seurat_files/Combined_data.h5Seurat", overwrite = T)

```
